{% extends "base.html" %}  

{% block style %}
{% endblock %}

{% block h1 %}
Dodaj klucz do API
{% endblock %}

{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 form-container">
            <label class="form-label">Used OpenAI tokens: {{user.account.tokens_used}}</label>
            <form id="createForm" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label" for="openai_api_key">OpenAI API key:</label>
                    <input type="text" class="form-control" id="openai_api_key" name="openai_api_key" value="{{user.account.openai_api_key}}">
                    {% if user.is_staff %}
                    <label class="form-label" for="semstorm_api_key">Semstorm API key:</label>
                    <input type="text" class="form-control" id="semstorm_api_key" name="semstorm_api_key" value="{{user.account.semstorm_api_key}}">
                    {% endif %}
                </div>
                <button type="submit" class="btn btn-primary btn-block">Submit</button>
            </form>
        </div>
    </div>

    <div class="row" style="margin-top: 3em;">
        {% regroup data by task_id as task_list %}

        {% for task in task_list %}
          <div class="col-md-12">
            <div class="card shadow">
                <div class="card-body">
                    <h3>Task ID: {{ task.grouper }} - Keywords: 
                      {% for row in task.list %}
                        {{ row.keyword }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </h3>
                    <p>Click to see task details</p>
                </div>
                <div class="additional-attributes">
                    <table>
                        <thead>
                          <tr>
                            <th>Status</th>
                            <th>URL</th>
                            <th>Keyword</th>
                            <th>Link</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in task.list %}
                            <tr>
                              <td>{% if row.done %}Done{% else %}Writing{% endif %}</td>
                              <td>{{ row.url }}</td>
                              <td>{{ row.keyword }}</td>
                              <td>{{ row.link }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                </div>
            </div>
          </div>
        {% endfor %}        
    </div>
</div>

{% endblock %}


{% block script %}
<script>
    $(document).ready(function() {
        $('#createForm').on('submit', function(event) {
            event.preventDefault(); // Prevent form from submitting normally
            
            // Serialize form data
            var formData = $(this).serialize();
            // console.log(formData);

            /*
            // Check if any field is empty
            var emptyFields = false;
            $(this).find('input').each(function() {
                if ($(this).val() === '') {
                    emptyFields = true;
                    return false; // Exit the loop early
                }
            });
            
            if (emptyFields) {
                alert('Please fill in all fields.');
                return; // Do not proceed with submission
            }
            */
            
            // Send POST request to the /api/all/ endpoint
            $.ajax({
                type: 'POST',
                url: '/user/',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: formData,
                success: function(response) {
                    // Handle success response here
                    window.location.href = '/';
                },
                error: function(error) {
                    // Handle error response here
                    console.log(error);
                }
            });
        });
    });
</script>
{% endblock %}